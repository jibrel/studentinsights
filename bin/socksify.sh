# Expects:
# QUOTAGUARDSTATIC_HOST
# QUOTAGUARDSTATIC_USERNAME
# QUOTAGUARDSTATIC_PASSWORD
# SOCKS_DEBUG (optional)

PROXY_FOLDER=/app/vendor/dante

# Write config file to socks.conf
rm -f $SOCKS_CONF
IFS=","
for QUOTAGUARDSTATIC_MASK_PART in $QUOTAGUARDSTATIC_MASK; do
  QUOTAGUARDSTATIC_MASK_ESCAPED=${QUOTAGUARDSTATIC_MASK_PART/\//\\/}
  cat "${PROXY_FOLDER}/socks.conf.template" | \
    sed -e "s/%QUOTAGUARDSTATIC_HOST%/${QUOTAGUARDSTATIC_HOST}/g" \
        -e "s/%QUOTAGUARDSTATIC_MASK%/${QUOTAGUARDSTATIC_MASK_ESCAPED}/g" \
        >> "$PROXY_FOLDER/socks.conf"
done

# Run 
SOCKS_USERNAME="${QUOTAGUARDSTATIC_USERNAME}" \
SOCKS_PASSWORD="${QUOTAGUARDSTATIC_PASSWORD}" \
SOCKS_LOGOUTPUT="$PROXY_FOLDER/socks.log" \
SOCKS_CONF="$PROXY_FOLDER/socks.conf" \
LD_LIBRARY_PATH="$PROXY_FOLDER/lib" \
LD_PRELOAD="$PROXY_FOLDER/lib/libdsocks.so" \
exec "$@"